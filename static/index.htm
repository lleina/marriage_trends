<html>
<head>
    <!---Imports d3--->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .gridlines line {
            stroke: #bbb;
        }

        .gridlines .domain {
            stroke: none;
        }
        
        .line {
            fill: none;
            stroke: steelblue;
            stroke-width: 2;
        }
        
        .dot {
            fill: steelblue; /* Fills the circles with the same color as the line */
            stroke: steelblue;
            stroke-width: 2;
        }
    </style>
</head>
<body>
    <svg id="linesvg" height="500" width="800" style="border:1px solid rgb(0, 0, 0)"></svg>

    <script>
        const linesvg = d3.select("svg#linesvg");
        const width = linesvg.attr("width");
        const height = linesvg.attr("height");
        const margins = { top: 10, right: 10, bottom: 50, left: 50 };
        const lineWidth = width - margins.left - margins.right;
        const lineHeight = height - margins.top - margins.bottom;

        const requestData = async function () {

            d3.csv('./both_sexes.csv', d3.autoType)
                .then((data) => {
                    const yearExtent = d3.extent(data, d => d['year']);
                    const yearScale = d3.scaleLinear().domain(yearExtent).range([0, lineWidth])

                    const marriageExtent = d3.extent(data, d => (1 - d['all_2534']));
                    const marriageScale = d3.scaleLinear().domain(marriageExtent).range([lineHeight, 0])

                    // Draw gridlines first
                    let leftGridlines = d3.axisLeft(marriageScale)
                        .tickSize(-lineWidth - 10)
                        .tickFormat('');
                    linesvg.append('g').attr('class', 'gridlines')
                        .attr('transform', `translate(${margins.left - 10},${margins.top})`)
                        .call(leftGridlines)

                    let bottomGridlines = d3.axisBottom(yearScale)
                        .tickSize(-lineHeight - 10)
                        .tickFormat('')
                        .ticks(8);
                    linesvg.append('g').attr('class', 'gridlines')
                        .attr('transform', `translate(${margins.left},${lineHeight + margins.top + 10})`)
                        .call(bottomGridlines);

                    const line = d3.line()
                        .x(d => yearScale(d['year']))
                        .y(d => marriageScale(1 - d['all_2534']))
                        .curve(d3.curveMonotoneX); // This makes the line smoother

                    linesvg.append("path")
                        .datum(data)
                        .attr("class", "line")
                        .attr("d", line)
                        .attr('transform', `translate(${margins.left},${margins.top})`);
                    
                    // Adding dots for each data point
                    linesvg.selectAll(".dot")
                        .data(data)
                        .enter().append("circle") // Uses the enter().append() method
                        .attr("class", "dot") // Assign a class for styling
                        .attr("cx", d => yearScale(d['year']) + margins.left)
                        .attr("cy", d => marriageScale(1 - d['all_2534']) + margins.top)
                        .attr("r", 5)
                        .append("title") // Adding tooltip functionality
                        .text(d => `Year: ${d['year']}\nMarriage Rate: ${((1 - d['all_2534']) * 100).toFixed(2)}%`);

                    // Axis should be drawn after gridlines
                    let leftAxis = d3.axisLeft(marriageScale)
                        .tickFormat(d3.format('.0%'))
                        .ticks(8);
                    linesvg.append('g')
                        .attr('class', 'y axis')
                        .attr('transform', `translate(${margins.left - 10},${margins.top})`)
                        .call(leftAxis);

                    let bottomAxis = d3.axisBottom(yearScale)
                        .tickFormat(d3.format('d'))
                    linesvg.append('g')
                        .attr('class', 'y axis')
                        .attr('transform', `translate(${margins.left},${lineHeight + margins.top + 10})`)
                        .call(bottomAxis);
                })
        }

        requestData();
    </script>
</body>
</html>




<html>

<head>
    <!---Imports d3--->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background-color: #fff0f5;
            /* Light pink background */
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 20px;
            justify-content: center;
            align-items: start;
            width: 90%;
            max-width: 1024px;
            margin: 0 auto;
        }

        #checkboxForm,
        #legend {
            border: 1px solid #ffccd5;
            padding: 10px;
            border-radius: 5px;
            background-color: #ffe4e9;
            /* Very light pink background */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            /* width: calc(50% - 20px);  Adjust width to account for the grid gap */
        }

        svg {
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        input[type="checkbox"],
        .legend rect {
            margin-right: 10px;
        }

        label,
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px;
            cursor: pointer;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #d26a8d;
            /* Pinkish lines for the axis */
            shape-rendering: crispEdges;
        }

        .axis text {
            font-size: 0.9em;
            color: #7e072f;
            /* Pinkish text color */
        }

        #checkboxForm {
            border: 1px solid #ffccd5;
            /* Lighter pink border for the form */
            padding: 10px;
            border-radius: 5px;
            background-color: #ffe4e9;
            /* Very light pink background for the form */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .legend {
            font-size: 0.9em;
        }

        .legend rect {
            stroke: #ffccd5;
            stroke-width: 2px;
        }

        .legend,
        .axis text {
            font-size: 0.9em;
            color: #7e072f;
            /* Pinkish text color */
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #d26a8d;
            /* Pinkish lines for the axis */
            shape-rendering: crispEdges;
        }

        .line {
            stroke-width: 2px;
        }

        .dot {
            fill: steelblue;
        }

        .gridlines line {
            stroke: #eee;
            /* Lighter gridlines for softer appearance */
        }

        .gridlines .domain {
            stroke: none;
        }

        .line {
            fill: none;
            stroke-width: 2;
        }

        .dot {
            stroke-width: 2;
        }

        .title {
            font-size: 1.5em;
            font-weight: bold;
            color: #d26a8d;
            margin: 20px 0;
        }

        .checkbox-group {
            display: inline-block;
            margin-right: 20px;
        }

        .clearfix::after {
            content: "";
            clear: both;
            display: table;
        }

        .checkbox-group label {
            display: block;
            margin-bottom: 5px;
        }

        .checkbox-group label input[type="checkbox"] {
            margin-right: 5px;
        }

        .checkbox-group-heading {
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="title">Marriage Trends Visualization</div>
    <div class="container">
        <svg id="linesvg" height="500" width="800"></svg>
        <svg id="bargraph" width="800" height="500" viewBox="-40 -90 800 620"></svg>
        <form id="checkboxForm">
            <div class="checkbox-group" id="educationGroup">
                <strong class="checkbox-group-heading">Level of Education</strong>
                <label for="HS">
                    <input type="checkbox" id="HS" value="HS">
                    High school graduates or less (HS)
                </label>
                <label for="SC">
                    <input type="checkbox" id="SC" value="SC">
                    Some college (SC)
                </label>
                <label for="BAp">
                    <input type="checkbox" id="BAp" value="BAp">
                    Bachelor's degree or more (BAp)
                </label>
            </div>
            <div class="checkbox-group" id="ethnicityGroup">
                <strong class="checkbox-group-heading">Ethnicity</strong>
                <label for="White">
                    <input type="checkbox" id="White" value="White">
                    Non-Hispanic white (White)
                </label>
                <label for="Black">
                    <input type="checkbox" id="Black" value="Black">
                    Black or African American (Black)
                </label>
                <label for="Hisp">
                    <input type="checkbox" id="Hisp" value="Hisp">
                    Hispanic (Hisp)
                </label>
            </div>
        </form>
        <svg id="legend" width="800" height="100"></svg>
    </div>


    <script>
        const linesvg = d3.select("svg#linesvg");
        const width = linesvg.attr("width");
        const height = linesvg.attr("height");
        const margins = { top: 70, right: 20, bottom: 70, left: 80 };
        const lineWidth = width - margins.left - margins.right;
        const lineHeight = height - margins.top - margins.bottom;
        let selectedYears = []; //tracks up to two selected years

        const colorMapping = {
            'all_2534': 'blue', // Assign appropriate colors
            'all_3544': 'blue',
            'HS_2534': 'green',
            'HS_3544': 'green',
            'SC_2534': 'orange',
            'SC_3544': 'orange',
            'BAp_2534': 'purple',
            'BAp_3544': 'purple',
            'White_2534': 'pink',
            'White_3544': 'pink',
            'Black_2534': 'brown',
            'Black_3544': 'brown',
            'Hisp_2534': 'orange',
            'Hisp_3544': 'orange'
        };

        linesvg.append("text")
            .attr("class", "chart-title")
            .attr("x", lineWidth / 2 + 40)
            .attr("y", 30)
            .attr("text-anchor", "middle")
            .style("font-weight", "bold")
            .style("font-size", "20px")
            .style("fill", "black")
            .text("Percentage of a Population Married in Each Year");

        linesvg.append("text")
            .attr("class", "y-axis-title")
            .attr("transform", "rotate(-90)")
            .attr("x", -lineHeight / 2 - 70)
            .attr("y", 30)
            .attr("text-anchor", "middle")
            .text("Percentage of Population Married");

        linesvg.append("text")
            .attr("class", "x-axis-title")
            .attr("x", lineWidth / 2 + 50)
            .attr("y", lineHeight + 120)
            .attr("text-anchor", "middle")
            .text("Year");

        const legendData = Object.keys(colorMapping);

        const requestData = async function () {

            d3.csv('./both_sexes.csv', d3.autoType)
                .then((data) => {
                    const yearExtent = d3.extent(data, d => d['year']);
                    const yearScale = d3.scaleLinear().domain(yearExtent).range([0, lineWidth])

                    const marriageExtent = d3.extent(data, d => (1 - d['all_2534']));
                    const marriageScale = d3.scaleLinear().domain([marriageExtent[0] - 0.2, marriageExtent[1] + 0.1]).range([lineHeight, 0])

                    // Draw gridlines first
                    let leftGridlines = d3.axisLeft(marriageScale)
                        .tickSize(-lineWidth - 10)
                        .tickFormat('');
                    linesvg.append('g').attr('class', 'gridlines')
                        .attr('transform', `translate(${margins.left - 10},${margins.top})`)
                        .call(leftGridlines)

                    let bottomGridlines = d3.axisBottom(yearScale)
                        .tickSize(-lineHeight - 10)
                        .tickFormat('')
                        .ticks(8);
                    linesvg.append('g').attr('class', 'gridlines')
                        .attr('transform', `translate(${margins.left},${lineHeight + margins.top + 10})`)
                        .call(bottomGridlines);


                    let mouseGroup = linesvg.append("g");

                    let xMarker = mouseGroup.append("line")
                        .attr("id", "xMarker")
                        .attr("fill", "none")
                        .attr("stroke", "black")
                        .attr("stroke-width", 1)
                        .attr("y1", margins.top - 10)
                        .attr("y2", lineHeight + margins.top)
                        .attr("visibility", "hidden");

                    let yearMarker = mouseGroup.append("text")
                        .attr("id", "yearMarker")
                        .attr("fill", "black")
                        .attr("stroke", "none")
                        .attr("stroke-width", 1)
                        .attr("style", "font-family: sans-serif;")
                        .attr("y", margins.top - 15)
                        .attr("visibility", "hidden");

                    let all2534Marker = mouseGroup.append("circle")
                        .attr("id", "all2534Marker")
                        .attr("fill", "none")
                        .attr("stroke", "black")
                        .attr("stroke-width", 2)
                        .attr("r", 7)
                        .attr("visibility", "hidden");

                    let all3544Marker = mouseGroup.append("circle")
                        .attr("id", "all3544Marker")
                        .attr("fill", "none")
                        .attr("stroke", "black")
                        .attr("stroke-width", 2)
                        .attr("r", 7)
                        .attr("visibility", "hidden");

                    function markerFunctor(id) {
                        return mouseGroup.append("circle")
                            .attr("id", id)
                            .attr("fill", "none")
                            .attr("stroke", "black")
                            .attr("opacity", 1)
                            .attr("stroke-width", 2)
                            .attr("r", 7)
                            .attr("visibility", "hidden");
                    }

                    let HS_2534Marker = markerFunctor('HS_2534Marker')
                    let HS_3544Marker = markerFunctor('HS_3544Marker')

                    let SC_2534Marker = markerFunctor('SC_2534Marker')
                    let SC_3544Marker = markerFunctor('SC_3544Marker')

                    let BAp_2534Marker = markerFunctor('BAp_2534Marker')
                    let BAp_3544Marker = markerFunctor('BAp_3544Marker')

                    let White_2534Marker = markerFunctor('White_2534Marker')
                    let White_3544Marker = markerFunctor('White_3544Marker')

                    let Black_2534Marker = markerFunctor('Black_2534Marker')
                    let Black_3544Marker = markerFunctor('Black_3544Marker')

                    let Hisp_2534Marker = markerFunctor('Hisp_2534Marker')
                    let Hisp_3544Marker = markerFunctor('Hisp_3544Marker')

                    let activeRegion = mouseGroup.append("rect")
                        .attr("id", "activeRegion")
                        .attr("width", lineWidth)
                        .attr("height", lineHeight)
                        .attr("fill", "none")
                        .attr("pointer-events", "all");

                    activeRegion.on("mouseover", function () {
                        xMarker.attr("visibility", "visible");
                        yearMarker.attr("visibility", "visible");
                        all2534Marker.attr("visibility", "visible");
                        all3544Marker.attr("visibility", "visible");

                        let checked = getCheckedCheckboxes()
                        //want marker to become visible

                        for (i = 0; i < checked.length; i++) {
                            let value2534Marker = d3.select("#" + checked[i] + '_2534Marker');
                            let value3544Marker = d3.select("#" + checked[i] + '_3544Marker');
                            value2534Marker.attr("visibility", "visible");
                            value3544Marker.attr("visibility", "visible");
                        }
                    });

                    activeRegion.on("mouseout", function () {
                        xMarker.attr("visibility", "hidden");
                        yearMarker.attr("visibility", "hidden");
                        all2534Marker.attr("visibility", "hidden");
                        all3544Marker.attr("visibility", "hidden");
                        let checked = getCheckedCheckboxes()
                        //want marker to become visible

                        for (i = 0; i < checked.length; i++) {
                            let value2534Marker = d3.select("#" + checked[i] + '_2534Marker');
                            let value3544Marker = d3.select("#" + checked[i] + '_3544Marker');
                            value2534Marker.attr("visibility", "hidden");
                            value3544Marker.attr("visibility", "hidden");
                        }

                    });

                    mouseGroup.attr('transform', `translate(${margins.left},${10})`);
                    let findYear = d3.bisector(d => d).center;

                    let years = []
                    data.forEach((row) => {
                        const year = row.year;
                        years.push(year);
                    })
                    // console.log(years)

                    function getCheckedCheckboxes() {
                        const checkedCheckboxes = [];
                        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                            if (checkbox.checked) {
                                checkedCheckboxes.push(checkbox.value);
                            }
                        });
                        return checkedCheckboxes;
                    }

                    activeRegion.on("mousemove", function (event) {
                        let location = d3.pointer(event);
                        let x = location[0];
                        let xDate = yearScale.invert(x);

                        let index = findYear(years, xDate);
                        let highlightedYear = years[index];
                        let datarow = []
                        data.forEach((row) => {
                            if (row['year'] === highlightedYear) {
                                datarow.push(row);
                            }
                        });

                        yearMarker.text(highlightedYear)
                            .attr("x", yearScale(highlightedYear))
                            .attr("text-anchor", "middle");
                        let xPos = yearScale(highlightedYear);
                        xMarker.attr("x1", xPos).attr("x2", xPos);

                        // console.log(datarow[0]['all_2534'])
                        let yPos = marriageScale(1 - datarow[0]['all_2534']);
                        let yPos2 = marriageScale(1 - datarow[0]['all_3544']);

                        all2534Marker.attr("cx", xPos).attr("cy", yPos + margins.top - 10);
                        all3544Marker.attr("cx", xPos).attr("cy", yPos2 + margins.top - 10);

                        // make loop for setting up the rest of the markers
                        const checkedList = getCheckedCheckboxes();
                        checkedList.forEach(value => {
                            const markername2534 = value + '_2534Marker';
                            const markername3544 = value + '_3544Marker';
                            d3.select("#" + markername2534)
                                .attr("cx", xPos)
                                .attr("cy", marriageScale(1 - datarow[0][value + '_2534']) + margins.top - 10);
                            d3.select("#" + markername3544)
                                .attr("cx", xPos)
                                .attr("cy", marriageScale(1 - datarow[0][value + '_3544']) + margins.top - 10);
                        });

                    });

                    let clickedMarker1 = linesvg.append("line").attr("visibility", "hidden");
                    let clickedMarker2 = linesvg.append("line").attr("visibility", "hidden");

                    activeRegion.on("click", function (event) {
                        let location = d3.pointer(event);
                        let x = location[0];
                        let xDate = yearScale.invert(x);
                        let index = findYear(years, xDate);
                        let highlightedYear = years[index];

                        // Add or remove the year from the selection
                        const yearIndex = selectedYears.indexOf(highlightedYear);
                        if (yearIndex > -1) {
                            selectedYears.splice(yearIndex, 1); // Deselect if already selected
                        } else {
                            if (selectedYears.length < 2) {
                                selectedYears.push(highlightedYear); // Add new selection
                            } else {
                                selectedYears.shift(); // Remove the oldest selection if two are already selected
                                selectedYears.push(highlightedYear);
                            }
                        }

                        // Update markers based on the new state of selectedYears
                        updateMarkers(selectedYears);


                        if (data && selectedYears.length > 0) {
                            updateBarGraph(selectedYears, data); //dynamic update
                        } else {
                            //clear the bar graph if no years are selected
                            d3.select("#bargraph").selectAll("*").remove();
                        }
                    });


                    function updateMarkers(selectedYears) {
                        // Hide both markers initially
                        clickedMarker1.attr("visibility", "hidden");
                        clickedMarker2.attr("visibility", "hidden");

                        // Update marker positions based on selectedYears
                        selectedYears.forEach((year, index) => {
                            let marker = (index === 0) ? clickedMarker1 : clickedMarker2;
                            marker.attr("visibility", "visible")
                                .attr("x1", yearScale(year) + margins.left)
                                .attr("x2", yearScale(year) + margins.left)
                                .attr("y1", margins.top)
                                .attr("y2", height - margins.bottom + 10)
                                .attr("stroke", "black")
                                .attr("stroke-width", 2);
                        });
                    }

                    linesvg.selectAll("circle.all_2534").data(data)
                        .join("circle")
                        .attr("cx", d => yearScale(d['year']) + margins.left)
                        .attr("cy", d => marriageScale(1 - d['all_2534']) + margins.top)
                        .attr("r", 5)
                        .attr("fill", "blue")
                        .attr("opacity", 0.5)
                        .on("mouseover", mouseOn)
                        .on("mouseout", mouseOut)
                        .on("click", function (event, d) {
                            updateMarkers(selectedYears);
                        });

                    linesvg.selectAll("circle.all_3544").data(data)
                        .join("circle")
                        .attr("cx", d => yearScale(d['year']) + margins.left)
                        .attr("cy", d => marriageScale(1 - d['all_3544']) + margins.top)
                        .attr("r", 5)
                        .attr("opacity", 1)
                        .attr("fill", "blue")
                        .on("mouseover", mouseOn)
                        .on("mouseout", mouseOut)
                        .on("click", function (event, d) {
                            updateMarkers(selectedYears);
                        });

                    const line25 = d3.line()
                        .x(d => yearScale(d['year']))
                        .y(d => marriageScale(1 - d['all_2534']))
                        .curve(d3.curveMonotoneX);

                    linesvg.append("path")
                        .datum(data)
                        .attr("class", "line")
                        .attr("d", line25)
                        .attr("opacity", 0.5)
                        .attr("stroke", "blue")
                        .attr('transform', `translate(${margins.left},${margins.top})`);

                    const line35 = d3.line()
                        .x(d => yearScale(d['year']))
                        .y(d => marriageScale(1 - d['all_3544']))
                        .curve(d3.curveMonotoneX);

                    linesvg.append("path")
                        .datum(data)
                        .attr("class", "line")
                        .attr("stroke", "blue")
                        .attr("d", line35)
                        .attr('transform', `translate(${margins.left},${margins.top})`)


                    function lineFunctor(dataName, data, color, line) {
                        if (dataName.indexOf("2534") !== -1) {
                            linesvg.selectAll("circle." + dataName).data(data)
                                .join("circle")
                                .attr("class", "circle" + dataName)
                                .attr("cx", d => yearScale(d['year']) + margins.left)
                                .attr("cy", d => marriageScale(1 - d[dataName]) + margins.top)
                                .attr("r", 5)
                                .attr("opacity", 0.5)
                                .attr("fill", color)
                                .attr("visibility", "hidden")
                                .on("mouseover", mouseOn)
                                .on("mouseout", mouseOut)
                                .on("click", function (event, d) {
                                    updateMarkers(selectedYears);
                                });

                            linesvg.append("path")
                                .datum(data)
                                .attr("class", "line" + dataName)
                                .attr("d", line)
                                .attr("fill", "none")
                                .attr("stroke", color)
                                .attr("opacity", 0.5)
                                .attr("stroke-width", 2)
                                .attr('transform', `translate(${margins.left},${margins.top})`)
                                .attr("visibility", "hidden");
                        }
                        else {
                            linesvg.selectAll("circle." + dataName).data(data)
                                .join("circle")
                                .attr("class", "circle" + dataName)
                                .attr("cx", d => yearScale(d['year']) + margins.left)
                                .attr("cy", d => marriageScale(1 - d[dataName]) + margins.top)
                                .attr("r", 5)
                                .attr("opacity", 1)
                                .attr("fill", color)
                                .attr("visibility", "hidden")
                                .on("mouseover", mouseOn)
                                .on("mouseout", mouseOut)
                                .on("click", function (event, d) {
                                    updateMarkers(selectedYears);
                                });

                            linesvg.append("path")
                                .datum(data)
                                .attr("class", "line" + dataName)
                                .attr("d", line)
                                .attr("fill", "none")
                                .attr("stroke", color)
                                .attr("opacity", 1)
                                .attr("stroke-width", 2)
                                .attr('transform', `translate(${margins.left},${margins.top})`)
                                .attr("visibility", "hidden");
                        }
                    }

                    const lineHS_2534 = d3.line()
                        .x(d => yearScale(d['year']))
                        .y(d => marriageScale(1 - d['HS_2534']))
                        .curve(d3.curveMonotoneX);
                    lineFunctor('HS_2534', data, colorMapping['HS_2534'], lineHS_2534);

                    const lineHS_3544 = d3.line()
                        .x(d => yearScale(d['year']))
                        .y(d => marriageScale(1 - d['HS_3544']))
                        .curve(d3.curveMonotoneX);
                    lineFunctor('HS_3544', data, colorMapping['HS_3544'], lineHS_3544);

                    const lineSC_2534 = d3.line()
                        .x(d => yearScale(d['year']))
                        .y(d => marriageScale(1 - d['SC_2534']))
                        .curve(d3.curveMonotoneX);
                    lineFunctor('SC_2534', data, colorMapping['SC_2534'], lineSC_2534);

                    const lineSC_3544 = d3.line()
                        .x(d => yearScale(d['year']))
                        .y(d => marriageScale(1 - d['SC_3544']))
                        .curve(d3.curveMonotoneX);
                    lineFunctor('SC_3544', data, colorMapping['SC_3544'], lineSC_3544);

                    const lineBAp_2534 = d3.line()
                        .x(d => yearScale(d['year']))
                        .y(d => marriageScale(1 - d['BAp_2534']))
                        .curve(d3.curveMonotoneX);
                    lineFunctor('BAp_2534', data, colorMapping['BAp_2534'], lineBAp_2534);

                    const lineBAp_3544 = d3.line()
                        .x(d => yearScale(d['year']))
                        .y(d => marriageScale(1 - d['BAp_3544']))
                        .curve(d3.curveMonotoneX);
                    lineFunctor('BAp_3544', data, colorMapping['BAp_3544'], lineBAp_3544);

                    const lineWhite_2534 = d3.line()
                        .x(d => yearScale(d['year']))
                        .y(d => marriageScale(1 - d['White_2534']))
                        .curve(d3.curveMonotoneX);
                    lineFunctor('White_2534', data, colorMapping['White_2534'], lineWhite_2534);

                    const lineWhite_3544 = d3.line()
                        .x(d => yearScale(d['year']))
                        .y(d => marriageScale(1 - d['White_3544']))
                        .curve(d3.curveMonotoneX);
                    lineFunctor('White_3544', data, colorMapping['White_3544'], lineWhite_3544);

                    const lineBlack_2534 = d3.line()
                        .x(d => yearScale(d['year']))
                        .y(d => marriageScale(1 - d['Black_2534']))
                        .curve(d3.curveMonotoneX);
                    lineFunctor('Black_2534', data, colorMapping['Black_2534'], lineBlack_2534);

                    const lineBlack_3544 = d3.line()
                        .x(d => yearScale(d['year']))
                        .y(d => marriageScale(1 - d['Black_3544']))
                        .curve(d3.curveMonotoneX);
                    lineFunctor('Black_3544', data, colorMapping['Black_3544'], lineBlack_3544);

                    const lineHisp_2534 = d3.line()
                        .x(d => yearScale(d['year']))
                        .y(d => marriageScale(1 - d['Hisp_2534']))
                        .curve(d3.curveMonotoneX);
                    lineFunctor('Hisp_2534', data, colorMapping['Hisp_2534'], lineHisp_2534);

                    const lineHisp_3544 = d3.line()
                        .x(d => yearScale(d['year']))
                        .y(d => marriageScale(1 - d['Hisp_3544']))
                        .curve(d3.curveMonotoneX);
                    lineFunctor('Hisp_3544', data, colorMapping['Hisp_3544'], lineHisp_3544);


                    function becomeVisible(value) {
                        const value2534 = value + '_2534';
                        const value3544 = value + '_3544';

                        linesvg.selectAll(".circle" + value2534).attr("visibility", "visible");
                        linesvg.selectAll("path.line" + value2534).attr("visibility", "visible");

                        linesvg.selectAll(".circle" + value3544).attr("visibility", "visible");
                        linesvg.selectAll("path.line" + value3544).attr("visibility", "visible");
                    }

                    function becomeInvisible(value) {
                        const value2534 = value + '_2534';
                        const value3544 = value + '_3544';

                        linesvg.selectAll(".circle" + value2534).attr("visibility", "hidden");
                        linesvg.selectAll("path.line" + value2534).attr("visibility", "hidden");

                        linesvg.selectAll(".circle" + value3544).attr("visibility", "hidden");
                        linesvg.selectAll("path.line" + value3544).attr("visibility", "hidden");

                        //want marker to become invisible
                        let value2534Marker = d3.select("#" + value + '_2534Marker');
                        let value3544Marker = d3.select("#" + value + '_3544Marker');
                        value2534Marker.attr("visibility", "hidden");
                        value3544Marker.attr("visibility", "hidden");
                    }

                    const legendSvg = d3.select("#legend");

                    const legendData = ["all_2534", "all_3544"];
                    console.log(legendData)

                    // Assuming each legend item needs 20px of height:
                    legendSvg.attr("height", legendData.length * 20 + 10);

                    const legend = legendSvg.selectAll(".legend")
                        .data(legendData)
                        .enter().append("g")
                        .attr("class", "legend")
                        .attr("transform", (d, i) => `translate(10, ${i * 20})`);

                    legend.append("rect")
                        .attr("x", 0)
                        .attr("width", 18)
                        .attr("height", 18)
                        .attr("opacity", d => d.indexOf("2534") !== -1 ? 0.5 : 1)
                        .attr("fill", d => colorMapping[d]);

                    legend.append("text")
                        .attr("x", 24)
                        .attr("y", 9)
                        .attr("dy", ".35em")
                        .text(d => `${d.split('_').slice(0, -1).join(' ')} (${d.split('_').pop() === '2534' ? '25-34 year olds' : '35-44 year olds'})`);

                    function updateLegend() {

                        // const legendSvg = d3.select("#legend");
                        legendSvg.selectAll("*").remove(); // Clear previous legends

                        const checked = getCheckedCheckboxes();

                        let checkedlist = checked.map(item => {
                            return [item + '_2534', item + '_3544'];
                        });
                        checkedlist = checkedlist.flat();
                        checkedlist.unshift('all_3544')
                        checkedlist.unshift('all_2534')
                        console.log(checkedlist)

                        // Assuming each legend item needs 20px of height:
                        legendSvg.attr("height", checkedlist.length * 20 + 10);

                        const legend = legendSvg.selectAll(".legend")
                            .data(checkedlist)
                            .enter().append("g")
                            .attr("class", "legend")
                            .attr("transform", (d, i) => `translate(10, ${i * 20})`);

                        legend.append("rect")
                            .attr("x", 0)
                            .attr("width", 18)
                            .attr("height", 18)
                            .attr("opacity", d => d.indexOf("2534") !== -1 ? 0.5 : 1)
                            .attr("fill", d => colorMapping[d]);

                        legend.append("text")
                            .attr("x", 24)
                            .attr("y", 9)
                            .attr("dy", ".35em")
                            .text(d => `${d.split('_').slice(0, -1).join(' ')} (${d.split('_').pop() === '2534' ? '25-34 year olds' : '35-44 year olds'})`)

                    }

                    function updateBarGraph(selectedYears, data) {
                        const benchmarkCategories = ["all_2534", "all_3544"];
                        const svg = d3.select("#bargraph");
                        const margin = { top: 20, right: 20, bottom: 30, left: 40 };
                        const width = +svg.attr("width") - margin.left - margin.right;
                        const height = +svg.attr("height") - margin.top - margin.bottom;


                        svg.selectAll("*").remove();

                        const checkedCategories = getCheckedCheckboxes();

                        const filteredData = data.filter(d => selectedYears.includes(d.year));
                        let barChartData = [];

                        filteredData.forEach(row => {
                            benchmarkCategories.forEach(category => {
                                barChartData.push({ category, value: 1 - row[category], year: row.year });
                            });
                        });

                        console.log(barChartData)

                        filteredData.forEach(row => {
                            checkedCategories.forEach(key => {
                                if (key !== "all") {
                                    const category = key + "_2534";
                                    const category2 = key + "_3544";
                                    barChartData.push({ category, value: 1 - row[category], year: row.year });
                                    barChartData.push({ category: category2, value: 1 - row[category2], year: row.year });
                                }
                            });
                        });

                        // Color scale
                        const colorScale = d3.scaleOrdinal()
                            .domain(benchmarkCategories.concat(checkedCategories.flatMap(key => [`${key}_2534`, `${key}_3544`])))
                            .range(["#6b486b", "#a05d56", ...d3.schemeTableau10]);

                        const x = d3.scaleBand().rangeRound([0, width]).padding(0.1);
                        const y = d3.scaleLinear().rangeRound([height, 0]);

                        x.domain(barChartData.map(d => `${d.year}_${d.category}`));
                        y.domain([0, d3.max(barChartData, d => d.value)]).nice();

                        svg.selectAll(".bar")
                            .data(barChartData)
                            .enter().append("rect")
                            .attr("class", "bar")
                            .attr("x", d => x(`${d.year}_${d.category}`))
                            .attr("y", d => y(d.value) + 30)
                            .attr("width", x.bandwidth())
                            .attr("height", d => height - y(d.value) - 30)
                            .attr("opacity", d => d.category.indexOf("2534") !== -1 ? 0.5 : 1)
                            .attr("fill", d => {
                                if (!colorMapping[d.category]) {
                                    console.log("Undefined category for color mapping:", d.category);
                                }
                                return colorMapping[d.category];
                            });

                        svg.selectAll(".label")
                            .data(barChartData)
                            .enter().append("text")
                            .attr("class", "label")
                            .attr("x", d => x(`${d.year}_${d.category}`) + x.bandwidth() / 2)
                            .attr("y", d => y(d.value) + 25)
                            .attr("text-anchor", "middle")
                            .text(d => d3.format(".1%")(d.value));

                        svg.append("g")
                            .attr("transform", `translate(0,${height})`)
                            .call(d3.axisBottom(x).tickFormat(d => {
                                let [year, category] = d.split("_");
                                return `${year} (${category})`;
                            }).ticks(barChartData.length))
                            .selectAll("text") // Select all text elements for the X-axis
                            .style("text-anchor", "end") // Position the anchor of the text at the end
                            .attr("dx", "-.8em") // Adjust distance from the tick (horizontal)
                            .attr("dy", ".15em") // Adjust distance from the tick (vertical)
                            .attr("transform", "rotate(-65)"); // Rotate text; negative for clockwise

                        svg.append("g")
                            .call(d3.axisLeft(y).ticks(null, "%"));

                        svg.append("text")
                            .attr("class", "chart-title")
                            .attr("x", lineWidth / 2 + 40)
                            .attr("y", -50)
                            .attr("text-anchor", "middle")
                            .style("font-weight", "bold")
                            .style("font-size", "25px")
                            .style("fill", "black")
                            .text("Percentage of a Population Married in Selected Years");

                        svg.append("text")
                            .attr("class", "y-axis-title")
                            .attr("transform", "rotate(-90)")
                            .attr("x", -lineHeight / 2 - 70)
                            .attr("y", -50)
                            .attr("text-anchor", "middle")
                            .style("font-size", "20px")
                            .text("Percentage of Population Married");

                        updateLegend();

                    }

                    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                        checkbox.addEventListener('change', function () {
                            if (this.checked) {
                                // console.log(this.value)
                                becomeVisible(this.value)
                                updateBarGraph(selectedYears, data)
                            } else {
                                // console.log(`Checkbox ${this.value} is unchecked`)
                                becomeInvisible(this.value)
                                updateBarGraph(selectedYears, data)
                            }
                        });
                    });

                    let leftAxis = d3.axisLeft(marriageScale)
                        .tickFormat(d3.format('.0%'))
                        .ticks(8);
                    linesvg.append('g')
                        .attr('class', 'y axis')
                        .attr('transform', `translate(${margins.left - 10},${margins.top})`)
                        .call(leftAxis);

                    let bottomAxis = d3.axisBottom(yearScale)
                        .tickFormat(d3.format('d'))
                    linesvg.append('g')
                        .attr('class', 'y axis')
                        .attr('transform', `translate(${margins.left},${lineHeight + margins.top + 10})`)
                        .call(bottomAxis);

                    function mouseOn(event, d) {
                        d3.select(this)
                            .attr("stroke", "black")
                            .attr("stroke-width", 2);
                        xMarker.attr("visibility", "visible");
                        yearMarker.attr("visibility", "visible");

                        all2534Marker.attr("visibility", "visible");
                        all3544Marker.attr("visibility", "visible");

                        let checked = getCheckedCheckboxes()
                        //want marker to become visible

                        for (i = 0; i < checked.length; i++) {
                            let value2534Marker = d3.select("#" + checked[i] + '_2534Marker');
                            let value3544Marker = d3.select("#" + checked[i] + '_3544Marker');
                            value2534Marker.attr("visibility", "visible");
                            value3544Marker.attr("visibility", "visible");
                        }

                    }

                    function mouseOut(event, d) {
                        d3.select(this)
                            .attr("stroke", "none")
                    }

                })
        }

        requestData();
    </script>
</body>

</html>